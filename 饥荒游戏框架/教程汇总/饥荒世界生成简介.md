## 总体流程

世界生成是指生成世界布局和内容的过程。其一般流程如下：

1. 首先，根据给定的预设(Perset)选择任务(Task)，其中有些任务(Task)是必选的，有些是可选的。
2. 每个任务(Task)会生成一组房间(Room)，然后将这些房间(Room)连接在一起。
3. 任务之间的链接是根据锁和钥匙进行的，如果某个任务的锁没有对应的钥匙，则该任务会被丢弃。
4. 对于每个任务，会添加背景房间。
5. 然后，将套件（包括必选和可选的）以及传送门组件分配到各个房间。
6. 接下来，会从图形中生成空间布局，并将其转换为地皮。（一个task对应一个graph）
7. 在洞穴中，会修复孤立的岛屿，并检查每个房间是否有足够的空间。如果空间不足，生成过程会重新开始。
8. 最后，会在每个节点处添加实体，并绘制道路以避开某些房间。（一个Node对应一个Room）

> 注意，源码中几个概念对应的英文为：
> 预设: Preset
> 任务: Task
> 房间: Room
> 锁: Lock
> 钥匙: Key
> 套件: Set Pieces
> 传送门: Teleportato
> 图形: Graph
> 地皮: Tiles
> 洞穴: Cave
> 岛屿: Island
> 节点: Node
> 道路: Road

## 预设(Preset)

每个世界生成预设都有不同的配置，这会导致不同的内容。洞穴、废墟和冒险模式关卡也有自己的预设。每个预设由任务（一些必选，一些可选）和套件组成。

## 游戏模式

饥荒单机和联机版中都有生存模式和冒险模式，通常启动游戏后玩家开始的是生存模式。在生存模式中可以找到**麦斯威尔之门**，通过**麦斯威尔之门**可以进入冒险模式。冒险模式拥有五个章节，但是每次启动冒险模式时都会从7个故事中随即挑选5个作为章节，7个故事分别为：  
* 冷淡的接待
* 冬季之王（永冬）
* 游戏进行时（步步为营）
* 群岛
* 两个世界
* 永夜
* 将军

## 任务(Task)

每个世界生成预设都有不同的配置，会产生不同的内容。洞穴、遗迹和冒险模式关卡也有自己的预设。每个预设由任务组成（一些是强制的，一些是可选的）和设定部件。例如，“Survival”和“Cave”预设会生成一些故事元素式的任务。每个任务会指定锁和钥匙，一系列房间（包括每种房间可以出现的数量）和背景草皮，该草皮确定了哪些实体不能出现在该任务中。  
举个例子，“杀死所有的蜘蛛；猪村陷入了危机！要到达猪村，你必须穿过一座山峰；巨石挡住了你的道路，所以你必须建造一个鹤嘴锄。你需要足够的肉来说服猪帮助你对抗蜘蛛，所以肉源也必须在附近。”  
为了满足这个故事，游戏会生成两个区域。第一个区域将包含蜘蛛、猪村和肉源；这个任务中会存在一个与该“故事元素”相对应的锁。第二个区域将包含岩石源、细枝和草源以及一个起始区域（其中包含一些燧石）；这些都是由房间生成的，但也可以用钥匙来表示。这为你提供了制作鹤嘴锄所需的资源，之后你将发现猪村处于危险之中，收集一些肉，雇佣一些猪，与邪恶的蜘蛛进行战斗。

## 房间(Room)

房间是包含特定内容的小型生态系统，每种生态系统类型都有多个不同的房间，因此在探索世界时会遇到各种类型的生态系统（例如带有或不带有杀手蜜蜂巢的蜜蜂领地）。生成房间时，还会创建一组节点，相互间距离适当，以确保房间内的物体被相对均匀地分布。房间会指定标签、一些特定实体的数量，并为在给定节点生成其他实体的概率设定概率，同时也会有特定的地块（或马赛克，随机混合了大多数地块）。

## 锁和钥匙(Lock & Key)

锁和钥匙指定了任务之间如何连接。每个钥匙可以解锁一个或多个锁。当任务被链接时，系统会尝试添加一个新任务，使得已有的任务拥有新任务锁所对应的钥匙，但是，如果这不可能，它将随机添加一个任务，因此锁和钥匙系统仅用于优先处理任务。后添加的任务更有可能位于世界边缘，并且这些任务通常需要中心位置提供的钥匙。

## 标签(Tag)

标签被附加到房间上，以标记它们需要添加某些需要更多注意力的特殊对象，而不仅仅是简单地生成。例如，标签可处理废墟中的迷宫，标记某些区域不允许建造道路，需要与周围区域进行额外或更少的连接，可以拥有眼骨或特定类型的虫洞。

## 世界生成的详细步骤

1. 使用预设方案。
2. 选择用于该世界的任务；包括所有必需任务以及指定数量的可选任务（通常为四个）中的随机选择。
    2.1. 随机分配一定数量的随机场景（通常为五个）到随机的任务中。
    2.2. 对于强制场景，指定数量的场景会被附加到它们可以附加到的任务上（在预设数据中指定）。
3. 针对预设中的每个任务，都会创建一个任务节点图。如果任务指定了一个“入口房间”，则从该房间开始（有时是根据概率选择），否则就从一个随机房间开始。接着，它会编制一个房间列表，根据任务指定的要求包含一些重复的房间。在仍有可选择的房间时，它会从列表中移除一个房间并生成它的内容，将其附加到任务中最后生成的一个房间的“房间节点图”中，这个图目前是线性的。如果任务指定了要创建一个循环，那么线性图的两端会相互连接形成一个环。还会根据任务的“交叉连接程度”（默认为1），在房间之间添加若干连接。随机选择两个房间节点，重复最多20次，如果它们不同、未连接且都不是入口房间，那么就将它们连接起来，同时将交叉连接程度减少1。当交叉连接程度降至0时，交叉连接就会停止。
4. 如果有任何任务没有锁定，则将它们添加到列表中；其中一个被选择为第一个任务。否则，将随机选择一个任务。从这个任务开始，一直运行循环，直到没有任务剩余。其余的任务按随机顺序编译成未使用任务的列表。它创建了一个表格，列出当前连接任务所提供的钥匙，以及提供它们的任务（最初，只有起始节点提供钥匙）。它查看每个未使用的任务，直到找到一个可以完全解锁的任务。如果没有任务完全解锁，则随机选择一个。所选任务将从未使用任务列表中移除，并连接到已添加任务之一，具体取决于陆地分支设置的程度（因为连接的任务按树形排列，它计算任务的深度——从第一个任务开始到树中步骤的数量，分支设置越高，则连接的节点距第一个节点越近）。基于岛屿概率，它可能会将刚添加的任务与陆地分开，只要它不是入口任务。
5. 根据是否循环陆地的概率（默认为50%），将任务节点图（默认为树状结构）添加为一个循环，通过将第一个任务与最后一个任务相连。需要注意的是，该循环由一个LOOP_BLANK任务关闭，该任务由无法通过的瓷砖组成（地表世界中为水，在洞穴/遗迹中为空）。因此，这将产生马蹄形的陆地，而不是一个圆形。
6. 每个任务都会被背景填充。对于任务中的每个房间节点，默认情况下使用0到2个背景房间(某些预设可以定义它们自己的后台房间数)。然而，入口任务总是使用1-2个 BLOCKER_BLANK房间来代替，这些房间是由水组成的(或者是空的空间)。
7. 对于每个任务，如果之前已经给它们分配了一个套件，它将尝试把这个套件分配给指定的房间(入口和空白房间将不会被分配，在某些情况下要求它是一个背景房间)。这个任务可能会失败，在这种情况下，不使用套件。
8. 如果相关的话，远程传送零件被分配到房间节点。
9. 该地图的整体物理排列是作为一个 Voronoi 地图生成的。这种方法可能会失败，但在放弃之前会尝试五次。
    9.1. 世界被地皮分割。  
    9.2. 探测到岛屿，如果是洞穴，就连接到大陆。  
    9.3. 检查房间的大小，以确保它们足够大，以适应他们需要的。否则，世界一代将重新启动。  
    9.4. 实体在它们分配的每个节点都被填充，现在它们已经有了物理位置。  
    9.5. 道路被绘制，避开标有“道路毒素”的房间。